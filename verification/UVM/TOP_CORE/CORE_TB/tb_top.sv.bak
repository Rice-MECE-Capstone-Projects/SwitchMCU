`timescale 1ns/1ps

import uvm_pkg::*;
`include "uvm_macros.svh"
`include "core_if.sv"
import core_smoke_test_pkg::*;

module tb_top;

  // Clock
  bit clk;
  core_if core_vif(clk);

  // Clock generation
  initial begin
    clk = 0;
    forever #5 clk = ~clk;
  end

  //------------------------------------------
  // Declare instruction memory interface signals
  //------------------------------------------
  logic [31:0] ins_mem_addrb;
  logic [31:0] ins_mem_doutb;
  logic [31:0] ins_mem_dinb;
  logic        ins_mem_clkb;
  logic        ins_mem_enb;
  logic        ins_mem_rstb;
  logic        ins_mem_rstb_busy;
  logic [3:0]  ins_mem_web;

  //------------------------------------------
  // Instruction Memory Model
  //------------------------------------------
  logic [31:0] imem_data;

  ins_mem_model imem (
    .clk  (clk),
    .addr (ins_mem_addrb),
    .data (imem_data)
  );

/*
  assign ins_mem_clkb      = clk;
  assign ins_mem_enb       = 1'b1;
  assign ins_mem_rstb      = 1'b0;
  assign ins_mem_web       = 4'b0000;
  assign ins_mem_dinb      = 32'h0;
  assign ins_mem_rstb_busy = 1'b0;

  // DUT reads instructions from here
  assign ins_mem_doutb = imem_data;
*/

  //------------------------------------------
  // Disable Data Memory interface entirely
  //------------------------------------------
  /*
  logic        data_mem_clkb;
  logic        data_mem_enb;
  logic        data_mem_rstb;
  logic [3:0]  data_mem_web;
  logic [31:0] data_mem_addrb;
  logic [31:0] data_mem_dinb;
  logic        data_mem_rstb_busy;
  logic [31:0] data_mem_doutb;

  assign data_mem_clkb      = clk;
  assign data_mem_enb       = 1'b0;
  assign data_mem_rstb      = 1'b0;
  assign data_mem_web       = 4'b0000;
  assign data_mem_addrb     = 32'h0;
  assign data_mem_dinb      = 32'h0;
  assign data_mem_rstb_busy = 1'b0;
  assign data_mem_doutb     = 32'h0;
  */

  //------------------------------------------
  // DUT
  //------------------------------------------
  riscv32i #(.N_param(32)) dut (
    .clk           (clk),
    .GPIO0_R0_CH1  (core_vif.GPIO0_R0_CH1),
    .GPIO0_R0_CH2  (core_vif.GPIO0_R0_CH2),
    .GPIO0_R1_CH1  (core_vif.GPIO0_R1_CH1),
    .GPIO0_R1_CH2  (core_vif.GPIO0_R1_CH2),
    .STOP_sim      (core_vif.STOP_sim),

    // DATA MEM DISCONNECTED FOR NOW
    .data_mem_clkb     (),
    .data_mem_enb      (),
    .data_mem_rstb     (),
    .data_mem_web      (),
    .data_mem_addrb    (),
    .data_mem_dinb     (),
    .data_mem_rstb_busy(),
    .data_mem_doutb    (),

    // INSTRUCTION MEM: connected to model
    .ins_mem_clkb      (ins_mem_clkb),
    .ins_mem_enb       (ins_mem_enb),
    .ins_mem_rstb      (ins_mem_rstb),
    .ins_mem_web       (ins_mem_web),
    .ins_mem_addrb     (ins_mem_addrb),
    .ins_mem_dinb      (ins_mem_dinb),
    .ins_mem_rstb_busy (ins_mem_rstb_busy),
    .ins_mem_doutb     (ins_mem_doutb)
  );

  //------------------------------------------
  // Start UVM
  //------------------------------------------
  initial begin
    uvm_config_db#(virtual core_if)::set(null, "*", "vif", core_vif);
    run_test("core_smoke_test");
  end

endmodule

